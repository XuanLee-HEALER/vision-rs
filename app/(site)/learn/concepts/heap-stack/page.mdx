import LearnLayout from '@/components/LearnLayout';
import MemoryLayout3D from '@/components/MemoryLayout3D';
import MermaidDiagram from '@/components/MermaidDiagram';

export const metadata = {
  title: 'å †ä¸æ ˆ - Vision-RS',
  description: 'Rust çš„å †æ ˆå†…å­˜ç®¡ç†'
};

<LearnLayout>

# å †ä¸æ ˆ

ç†è§£å †ï¼ˆHeapï¼‰å’Œæ ˆï¼ˆStackï¼‰æ˜¯æŒæ¡ Rust å†…å­˜ç®¡ç†çš„å…³é”®ã€‚

## æ ˆï¼ˆStackï¼‰

æ ˆæ˜¯ä¸€ç§ LIFOï¼ˆåè¿›å…ˆå‡ºï¼‰çš„æ•°æ®ç»“æ„ï¼Œç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡å’Œå‡½æ•°è°ƒç”¨ä¿¡æ¯ã€‚

### æ ˆçš„ç‰¹ç‚¹

- âš¡ **å¿«é€Ÿåˆ†é…å’Œé‡Šæ”¾**
- ğŸ“ **å¤§å°å›ºå®š**ï¼Œç¼–è¯‘æ—¶ç¡®å®š
- ğŸ”„ **è‡ªåŠ¨ç®¡ç†**ï¼Œå‡½æ•°è¿”å›æ—¶è‡ªåŠ¨æ¸…ç†
- ğŸ“¦ **è¿ç»­å†…å­˜**

### æ ˆä¸Šåˆ†é…çš„æ•°æ®

```rust
fn main() {
    let x = 5;          // æ ˆä¸Šçš„ i32
    let y = true;       // æ ˆä¸Šçš„ bool
    let arr = [1, 2, 3];  // æ ˆä¸Šçš„æ•°ç»„

    println!("{}, {}, {:?}", x, y, arr);
}  // x, y, arr ç¦»å¼€ä½œç”¨åŸŸï¼Œè‡ªåŠ¨é‡Šæ”¾
```

## å †ï¼ˆHeapï¼‰

å †æ˜¯ä¸€ä¸ªå¤§çš„å†…å­˜æ± ï¼Œç”¨äºåŠ¨æ€å¤§å°çš„æ•°æ®ã€‚

### å †çš„ç‰¹ç‚¹

- ğŸŒ **åˆ†é…è¾ƒæ…¢**ï¼ˆéœ€è¦åˆ†é…å™¨ï¼‰
- ğŸ“ **å¤§å°åŠ¨æ€**ï¼Œè¿è¡Œæ—¶ç¡®å®š
- ğŸ”§ **æ‰‹åŠ¨ç®¡ç†**ï¼ˆRust é€šè¿‡æ‰€æœ‰æƒè‡ªåŠ¨åŒ–ï¼‰
- ğŸ—‚ï¸ **éè¿ç»­å†…å­˜**

### å †ä¸Šåˆ†é…çš„æ•°æ®

```rust
fn main() {
    let s = String::from("hello");  // å †ä¸Šçš„ String
    let v = vec![1, 2, 3];          // å †ä¸Šçš„ Vec
    let b = Box::new(5);            // å †ä¸Šçš„ Box

    println!("{}, {:?}, {}", s, v, b);
}  // s, v, b ç¦»å¼€ä½œç”¨åŸŸï¼Œå †å†…å­˜è¢«é‡Šæ”¾
```

<MemoryLayout3D scenario="heap" />

## æ ˆä¸å †çš„å¯¹æ¯”

<MermaidDiagram
  chart={`
graph TD
    subgraph æ ˆ
        A[å‡½æ•°è°ƒç”¨] --> B[æ ˆå¸§]
        B --> C[å±€éƒ¨å˜é‡]
        B --> D[è¿”å›åœ°å€]
    end

    subgraph å †
        E[åŠ¨æ€åˆ†é…] --> F[String]
        E --> G[Vec]
        E --> H[Box]
    end

    C -.æŒ‡é’ˆ.-> F
    C -.æŒ‡é’ˆ.-> G
    C -.æŒ‡é’ˆ.-> H

    style A fill:#8aadf4,stroke:#8aadf4,color:#24273a
    style E fill:#f5a97f,stroke:#f5a97f,color:#24273a
  `}
/>

| ç‰¹æ€§ | æ ˆ | å † |
|------|------|------|
| é€Ÿåº¦ | å¿« | è¾ƒæ…¢ |
| å¤§å° | å›ºå®šï¼ˆç¼–è¯‘æ—¶ï¼‰ | åŠ¨æ€ï¼ˆè¿è¡Œæ—¶ï¼‰ |
| ç®¡ç† | è‡ªåŠ¨ | æ‰‹åŠ¨ï¼ˆRust è‡ªåŠ¨åŒ–ï¼‰|
| ç”Ÿå‘½å‘¨æœŸ | ä½œç”¨åŸŸ | æ˜¾å¼æ§åˆ¶ |
| å…¸å‹ç”¨é€” | å±€éƒ¨å˜é‡ | å¤§å¯¹è±¡ã€åŠ¨æ€å¤§å° |

## æ ˆå¸§

æ¯æ¬¡å‡½æ•°è°ƒç”¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼š

```rust
fn main() {           // main çš„æ ˆå¸§
    let x = 5;
    let y = foo(x);   // foo çš„æ ˆå¸§å…¥æ ˆ
    println!("{}", y);
}                     // main çš„æ ˆå¸§å‡ºæ ˆ

fn foo(n: i32) -> i32 {
    let result = n * 2;
    result
}                     // foo çš„æ ˆå¸§å‡ºæ ˆ
```

**æ ˆå¸§åŒ…å«**ï¼š

- å±€éƒ¨å˜é‡
- å‚æ•°
- è¿”å›åœ°å€
- ä¿å­˜çš„å¯„å­˜å™¨

## æ ˆæº¢å‡º

æ ˆç©ºé—´æœ‰é™ï¼ˆé€šå¸¸å‡  MBï¼‰ï¼Œé€’å½’è¿‡æ·±ä¼šå¯¼è‡´æ ˆæº¢å‡ºï¼š

```rust
fn infinite_recursion() {
    infinite_recursion();  // âš ï¸ æ ˆæº¢å‡ºï¼
}

// é¿å…ï¼šä½¿ç”¨è¿­ä»£æˆ–å°¾é€’å½’ä¼˜åŒ–
fn safe_loop() {
    let mut i = 0;
    loop {
        i += 1;
        if i > 1000000 {
            break;
        }
    }
}
```

## ä½•æ—¶ä½¿ç”¨å †

ä½¿ç”¨ `Box<T>` å°†æ•°æ®æ”¾åœ¨å †ä¸Šï¼š

```rust
fn main() {
    // é€’å½’ç±»å‹å¿…é¡»ä½¿ç”¨ Boxï¼ˆå¤§å°å›ºå®šï¼‰
    enum List {
        Cons(i32, Box<List>),
        Nil,
    }

    // å¤§å¯¹è±¡æ”¾åœ¨å †ä¸Š
    let large_array = Box::new([0; 1000000]);

    // éœ€è¦é•¿ç”Ÿå‘½å‘¨æœŸçš„æ•°æ®
    let heap_data = Box::new(42);
}
```

## String vs &str

```rust
fn main() {
    // &strï¼šæŒ‡å‘æ ˆæˆ–é™æ€å†…å­˜çš„å­—ç¬¦ä¸²åˆ‡ç‰‡
    let s: &str = "hello";  // å­—ç¬¦ä¸²å­—é¢é‡ï¼ˆé™æ€å†…å­˜ï¼‰

    // Stringï¼šå †åˆ†é…çš„å­—ç¬¦ä¸²
    let mut s = String::from("hello");
    s.push_str(", world");  // å¯ä»¥å¢é•¿

    println!("{}", s);
}
```

**å†…å­˜å¸ƒå±€**ï¼š

```
æ ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  s: &str     â”‚ â†’ é™æ€å†…å­˜ä¸­çš„ "hello"
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  s: String   â”‚
â”‚  â”œâ”€ ptr â”€â”€â”€â”€â”€â”¼â”€â†’ å †: "hello, world"
â”‚  â”œâ”€ len: 12  â”‚
â”‚  â””â”€ cap: 12  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Vec çš„å†…å­˜å¸ƒå±€

```rust
fn main() {
    let mut v = Vec::new();
    v.push(1);
    v.push(2);
    v.push(3);

    println!("é•¿åº¦: {}, å®¹é‡: {}", v.len(), v.capacity());
}
```

**å†…å­˜å¸ƒå±€**ï¼š

```
æ ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  v: Vec<i32> â”‚
â”‚  â”œâ”€ ptr â”€â”€â”€â”€â”€â”¼â”€â†’ å †: [1, 2, 3, _, _, ...]
â”‚  â”œâ”€ len: 3   â”‚
â”‚  â””â”€ cap: 8   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Rc å’Œ Arc

å¤šä¸ªæ‰€æœ‰è€…å…±äº«å †æ•°æ®ï¼š

```rust
use std::rc::Rc;

fn main() {
    let a = Rc::new(5);
    let b = Rc::clone(&a);  // å¼•ç”¨è®¡æ•° +1
    let c = Rc::clone(&a);  // å¼•ç”¨è®¡æ•° +1

    println!("å¼•ç”¨è®¡æ•°: {}", Rc::strong_count(&a));  // 3
}
```

## å®è·µå»ºè®®

### âœ… æ¨èåšæ³•

```rust
// 1. ä¼˜å…ˆä½¿ç”¨æ ˆï¼ˆé»˜è®¤ï¼‰
fn process_number(x: i32) -> i32 {
    x * 2
}

// 2. å¤§å¯¹è±¡æˆ–åŠ¨æ€å¤§å°ä½¿ç”¨å †
fn create_large_buffer() -> Vec<u8> {
    vec![0; 1000000]
}

// 3. éœ€è¦æ‰€æœ‰æƒè½¬ç§»çš„åœºæ™¯ä½¿ç”¨ Box
fn create_node() -> Box<Node> {
    Box::new(Node { value: 42, next: None })
}

struct Node {
    value: i32,
    next: Option<Box<Node>>,
}
```

### âŒ é¿å…åšæ³•

```rust
// âŒ ä¸å¿…è¦çš„ Box
fn bad() -> Box<i32> {
    Box::new(42)  // i32 å¾ˆå°ï¼Œæ²¡å¿…è¦æ”¾å †ä¸Š
}

// æ›´å¥½ï¼šç›´æ¥è¿”å›å€¼
fn good() -> i32 {
    42
}

// âŒ æ ˆä¸Šåˆ†é…è¿‡å¤§çš„æ•°ç»„
fn very_bad() {
    let huge = [0; 10_000_000];  // å¯èƒ½æ ˆæº¢å‡º
}

// æ›´å¥½ï¼šä½¿ç”¨ Vec
fn better() {
    let huge = vec![0; 10_000_000];  // å †åˆ†é…
}
```

## æ€§èƒ½è€ƒè™‘

**æ ˆåˆ†é…**ï¼š

- âš¡ å¿«é€Ÿï¼ˆåªéœ€ç§»åŠ¨æ ˆæŒ‡é’ˆï¼‰
- ğŸ”„ ç¼“å­˜å‹å¥½ï¼ˆå±€éƒ¨æ€§å¥½ï¼‰

**å †åˆ†é…**ï¼š

- ğŸŒ è¾ƒæ…¢ï¼ˆéœ€è¦åˆ†é…å™¨æŸ¥æ‰¾ç©ºé—²å—ï¼‰
- ğŸ’¾ å¯èƒ½ç¼“å­˜æœªå‘½ä¸­

```rust
use std::time::Instant;

fn main() {
    let start = Instant::now();

    // æ ˆåˆ†é…ï¼ˆå¿«ï¼‰
    for _ in 0..1_000_000 {
        let _x = [0; 100];
    }

    println!("æ ˆ: {:?}", start.elapsed());

    let start = Instant::now();

    // å †åˆ†é…ï¼ˆæ…¢ï¼‰
    for _ in 0..1_000_000 {
        let _v = vec![0; 100];
    }

    println!("å †: {:?}", start.elapsed());
}
```

## å°ç»“

- âœ… **æ ˆ**ï¼šå¿«é€Ÿã€å›ºå®šå¤§å°ã€è‡ªåŠ¨ç®¡ç†
- âœ… **å †**ï¼šçµæ´»ã€åŠ¨æ€å¤§å°ã€æ˜¾å¼ç®¡ç†
- âœ… Rust é€šè¿‡**æ‰€æœ‰æƒ**è‡ªåŠ¨ç®¡ç†å †å†…å­˜
- âœ… ä¼˜å…ˆä½¿ç”¨æ ˆï¼Œå¿…è¦æ—¶ä½¿ç”¨å †
- âœ… `Box`, `Vec`, `String` ç­‰ä½¿ç”¨å †åˆ†é…
- âœ… ç†è§£å†…å­˜å¸ƒå±€æœ‰åŠ©äºä¼˜åŒ–æ€§èƒ½

</LearnLayout>

export default ({ children }) => <>{children}</>;
